service:
  name: test

frameworkVersion: '>=1.0.0 <2.0.0'

provider:
  name: aws
  runtime: nodejs12.x
  stage: ${env:STAGE}
  stackName: ${env:STAGE}-breakout-data
  memorySize: 128
  timeout: 60
  logRetentionInDays: 14
  environment:
    STAGE: ${env:STAGE}
    HOST: ${cf:${env:DB_STACK_NAME}.DbEndPoint}
    DB_NAME: ${cf:${env:DB_STACK_NAME}.DbName}
    DB_SECRETS_ARN: ${cf:${env:DB_STACK_NAME}.DbSecretArn}
  # apiGateway: # Optional API Gateway global config
  #   restApiId: xxxxxxxxxx # REST API resource ID. Default is generated by the framework
  stackTags: # Optional CF stack tags
    env: ${env:STAGE}
  vpc:
    securityGroupIds:
      - ${cf:${env:DB_STACK_NAME}.DbSecurityGroupId}
    subnetIds:
      - ${cf:${env:DB_STACK_NAME}.DbSubnetOne}
      - ${cf:${env:DB_STACK_NAME}.DbSubnetTwo}
  tracing:
    apiGateway: false
    lambda: true

plugins:
  - serverless-webpack
  - serverless-offline

custom:
  webpack:
    webpackConfig: 'webpack.${env:WEBPACK_CONFIG}.js'
    stats: minimal

functions:
  GraphQl:
    handler: src/graphql/index.handler
    name: ${env:STAGE}-breakout-data-graphql
    description: GraphQL API for accessing breakout data
    environment:
      CACHE_ENDPOINT: ${cf:${env:CACHE_STACK_NAME}.CacheEndPoint}
      CACHE_TTL_IN_SECONDS: ${env:CACHE_TTL_IN_SECONDS}
    tags:
      env: ${env:STAGE}
    events:
      - http:
          path: /graphql
          method: post
  CacheLoader:
    handler: src/cache-loader/index.handler
    name: ${env:STAGE}-breakout-cache-loader
    description: Loader for breakout data cache
    environment:
      CACHE_ENDPOINT: ${cf:${env:CACHE_STACK_NAME}.CacheEndPoint}
      CACHE_TTL_IN_SECONDS: ${env:CACHE_TTL_IN_SECONDS}
    tags:
      env: ${env:STAGE}
    events:
      - http:
          path: /load
          method: post
  DataQuery:
    handler: src/data-query/index.handler
    name: ${env:STAGE}-breakout-data-query
    description: Testing database connection
    tags:
      env: ${env:STAGE}
    events:
      - http:
          path: /query
          method: get